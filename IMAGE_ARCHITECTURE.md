# Image Data Flow Architecture

## Complete Data Flow: Upload to Display

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    USER UPLOADS IMAGE                            â”‚
â”‚              (src/App.tsx - CreateListingPage)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Input: <input type="file" />  â”‚
        â”‚                                â”‚
        â”‚  State: imageFiles: File[]     â”‚
        â”‚                                â”‚
        â”‚  (NOT blob URLs, actual Files) â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Create FormData Object       â”‚
        â”‚                                â”‚
        â”‚   formData.append('images',    â”‚
        â”‚     File[0], File[1], ...)     â”‚
        â”‚                                â”‚
        â”‚   (Send actual File objects)   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚     POST /products             â”‚
        â”‚  (src/Services/dbService.ts)   â”‚
        â”‚  http://localhost:8001         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        â”‚       BACKEND PROCESSING       â”‚
        â”‚    (Backend/main.py)           â”‚
        â”‚                                â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚  â”‚ 1. Receive UploadFile[]  â”‚  â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚             â”‚                  â”‚
        â”‚             â–¼                  â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚  â”‚ 2. For each file:        â”‚  â”‚
        â”‚  â”‚    - Generate UUID       â”‚  â”‚
        â”‚  â”‚    - Create filename     â”‚  â”‚
        â”‚  â”‚    - {userId}/{uuid}.jpg â”‚  â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚             â”‚                  â”‚
        â”‚             â–¼                  â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  â”‚ 3. Upload to Supabase       â”‚
        â”‚  â”‚    bucket: product-images   â”‚
        â”‚  â”‚    path: userId/uuid.jpg    â”‚
        â”‚  â”‚                              â”‚
        â”‚  â”‚ supabase.storage             â”‚
        â”‚  â”‚  .from_('product-images')   â”‚
        â”‚  â”‚  .upload(filename, file)    â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚             â”‚                  â”‚
        â”‚             â–¼                  â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  â”‚ 4. Generate Public URL:      â”‚
        â”‚  â”‚                              â”‚
        â”‚  â”‚ https://PROJECT_ID.          â”‚
        â”‚  â”‚ supabase.co/storage/v1/      â”‚
        â”‚  â”‚ object/public/               â”‚
        â”‚  â”‚ product-images/              â”‚
        â”‚  â”‚ userId/uuid.jpg              â”‚
        â”‚  â”‚                              â”‚
        â”‚  â”‚ (Collect in array)           â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚             â”‚                  â”‚
        â”‚             â–¼                  â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  â”‚ 5. Save to PostgreSQL:       â”‚
        â”‚  â”‚                              â”‚
        â”‚  â”‚ INSERT INTO products         â”‚
        â”‚  â”‚ SET images = [               â”‚
        â”‚  â”‚   "https://..../uuid1.jpg",  â”‚
        â”‚  â”‚   "https://..../uuid2.jpg"   â”‚
        â”‚  â”‚ ]                            â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚             â”‚                  â”‚
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   RESPONSE: Success 200        â”‚
        â”‚   {                            â”‚
        â”‚     "id": "product123",        â”‚
        â”‚     "images": [                â”‚
        â”‚       "https://.../uuid1.jpg", â”‚
        â”‚       "https://.../uuid2.jpg"  â”‚
        â”‚     ],                         â”‚
        â”‚     ...                        â”‚
        â”‚   }                            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Update State:               â”‚
        â”‚  setProducts([...])          â”‚
        â”‚                              â”‚
        â”‚  Product {                   â”‚
        â”‚    images: string[]  âœ“       â”‚
        â”‚  }                           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  DISPLAY IN GRID (ProductCard)                  â”‚
â”‚                                                                 â”‚
â”‚  1. Validate array:                                             â”‚
â”‚     Array.isArray(product.images) âœ“                             â”‚
â”‚                                                                 â”‚
â”‚  2. Filter invalid values:                                      â”‚
â”‚     images.filter(url => typeof url === 'string')              â”‚
â”‚                                                                 â”‚
â”‚  3. Map to JSX:                                                 â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚     â”‚ {validImages.map((url, i) => (   â”‚                        â”‚
â”‚     â”‚   <button key={i}                â”‚                        â”‚
â”‚     â”‚     onClick={() =>               â”‚                        â”‚
â”‚     â”‚       setCurrentImage(i)          â”‚                        â”‚
â”‚     â”‚   >                               â”‚                        â”‚
â”‚     â”‚     <img src={url}                â”‚                        â”‚
â”‚     â”‚          alt={`Image ${i+1}`}    â”‚                        â”‚
â”‚     â”‚          onLoad={() => ...}      â”‚                        â”‚
â”‚     â”‚          onError={() => ...}     â”‚                        â”‚
â”‚     â”‚     />                            â”‚                        â”‚
â”‚     â”‚   </button>                       â”‚                        â”‚
â”‚     â”‚ ))}                               â”‚                        â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                                                                 â”‚
â”‚  4. Show Navigation (if 2+ images):                             â”‚
â”‚     [â—„] [IMG 1/3] [â–¶]                                           â”‚
â”‚     [â—][â—‹][â—‹] â† dot indicators                                  â”‚
â”‚                                                                 â”‚
â”‚  5. Fallback (if no valid images):                              â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚     â”‚      [ğŸ–¼ï¸ No image]               â”‚                        â”‚
â”‚     â”‚   (elegant placeholder)          â”‚                        â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              DISPLAY IN DETAIL (ProductDetailPage)              â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚  â”‚  Main Image Display:               â”‚                         â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚                         â”‚
â”‚  â”‚  â”‚ [â—„]                    [â–¶]  â”‚   â”‚                         â”‚
â”‚  â”‚  â”‚                              â”‚   â”‚                         â”‚
â”‚  â”‚  â”‚   <img src={displayImg}>    â”‚   â”‚                         â”‚
â”‚  â”‚  â”‚        src={currentImage}    â”‚   â”‚                         â”‚
â”‚  â”‚  â”‚                      [2/5]  â”‚   â”‚                         â”‚
â”‚  â”‚  â”‚                              â”‚   â”‚                         â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                         â”‚
â”‚  â”‚                                    â”‚                         â”‚
â”‚  â”‚  Thumbnail Gallery Below:          â”‚                         â”‚
â”‚  â”‚  â”Œâ”€â”€â” â”Œâ”€â”€â” â”Œâ”€â”€â” â”Œâ”€â”€â” â”Œâ”€â”€â”         â”‚                         â”‚
â”‚  â”‚  â”‚  â”‚ â”‚  â”‚ â”‚â–ˆâ–ˆâ”‚ â”‚  â”‚ â”‚  â”‚ â† (3)  â”‚                         â”‚
â”‚  â”‚  â””â”€â”€â”˜ â””â”€â”€â”˜ â””â”€â”€â”˜ â””â”€â”€â”˜ â””â”€â”€â”˜         â”‚                         â”‚
â”‚  â”‚         (click to select)          â”‚                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                                                                 â”‚
â”‚  JS Logic:                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚  â”‚ validImages = product.images    â”‚                           â”‚
â”‚  â”‚   .filter(url =>                â”‚                           â”‚
â”‚  â”‚     typeof url === 'string' &&  â”‚                           â”‚
â”‚  â”‚     url.trim() !== '')          â”‚                           â”‚
â”‚  â”‚                                 â”‚                           â”‚
â”‚  â”‚ displayImage = validImages[     â”‚                           â”‚
â”‚  â”‚   activeImage                   â”‚                           â”‚
â”‚  â”‚ ]                               â”‚                           â”‚
â”‚  â”‚                                 â”‚                           â”‚
â”‚  â”‚ <img src={displayImage} />      â”‚                           â”‚
â”‚  â”‚                                 â”‚                           â”‚
â”‚  â”‚ {validImages.map((img, i) => (  â”‚                           â”‚
â”‚  â”‚   <img key={i}                  â”‚                           â”‚
â”‚  â”‚     src={img}                   â”‚                           â”‚
â”‚  â”‚     onClick={() =>              â”‚                           â”‚
â”‚  â”‚       setActiveImage(i)          â”‚                           â”‚
â”‚  â”‚   />                             â”‚                           â”‚
â”‚  â”‚ ))}                              â”‚                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Type Flow

```
Frontend Upload:
  File[] â”€â”€â†’ FormData â”€â”€â†’ Backend

Backend Processing:
  UploadFile[] â”€â”€â†’ Supabase â”€â”€â†’ string[] (URLs)
                â”€â”€â†’ PostgreSQL â”€â”€â†’ ARRAY(String)

Backend Response:
  string[] â”€â”€â†’ JSON â”€â”€â†’ Frontend

Frontend State:
  Product {
    images: string[] âœ“
  }

Display:
  string[] â”€â”€â†’ .map() â”€â”€â†’ <img> â”€â”€â†’ Browser
            â”€â”€â†’ .filter() â”€â”€â†’ fallback if empty
```

## Key Data Transformations

### Upload Path

```typescript
// INPUT: HTMLInputElement
<input type="file" multiple />

// CAPTURE: File[]
const files: File[] = event.target.files

// SEND: FormData
const formData = new FormData()
formData.append('images', file1)  // File object
formData.append('images', file2)  // File object

// NOT: strings
formData.append('images', URL.createObjectURL(file))  // âŒ WRONG
```

### Response Path

```json
// Backend returns:
{
  "images": [
    "https://nufeuxdqjfithhleezox.supabase.co/storage/v1/object/public/product-images/user123/abc.jpg",
    "https://nufeuxdqjfithhleezox.supabase.co/storage/v1/object/public/product-images/user123/def.jpg"
  ]
}

// Frontend stores:
Product {
  images: string[]  // âœ“ Correct type
}

// Frontend renders:
validImages.map(url => <img src={url} />)
```

## Error Handling Points

```
Upload Error â”€â”€â†’ 422 Unprocessable Entity
  â””â”€ Cause: Sending strings instead of Files
  â””â”€ Fix: Send File[] objects in FormData

Supabase Error â”€â”€â†’ 404 Bucket Not Found
  â””â”€ Cause: Bucket missing or private
  â””â”€ Fix: Create public bucket 'product-images'

Image Load Error â”€â”€â†’ console.error
  â””â”€ Cause: Invalid URL or CORS issue
  â””â”€ Fix: Check URL is valid, add crossOrigin="anonymous"

Type Error â”€â”€â†’ TypeError
  â””â”€ Cause: images not array
  â””â”€ Fix: Always validate Array.isArray(images)
```

## Validation Layers

```
Layer 1: Backend (Python)
  â”œâ”€ isinstance(images, list) âœ“
  â”œâ”€ validate UploadFile types âœ“
  â””â”€ generate URLs âœ“

Layer 2: API Response
  â”œâ”€ JSON parsed âœ“
  â””â”€ contains "images": [...] âœ“

Layer 3: Frontend Type (React)
  â”œâ”€ Product type guarantees images: string[] âœ“
  â””â”€ TypeScript compilation checks âœ“

Layer 4: Component Validation
  â”œâ”€ Array.isArray(product.images) âœ“
  â”œâ”€ .filter() removes invalid items âœ“
  â”œâ”€ .length > 0 check âœ“
  â””â”€ Safe .map() iteration âœ“

Layer 5: DOM Rendering
  â”œâ”€ <img src={validUrl} /> âœ“
  â”œâ”€ onLoad handler âœ“
  â”œâ”€ onError handler âœ“
  â””â”€ Fallback placeholder âœ“
```

---

**Key Takeaway**: Images flow as `File[] â†’ string[] â†’ <img>` with validation at each layer.
